# AIåŠ¨æ€æ’ä»¶å¼€å‘è¾…åŠ©æ–‡æ¡£

åŸºäºç°æœ‰QQåŠ¨æ€æ’ä»¶çš„åˆ†æå’ŒAstrBotæ’ä»¶å¼€å‘è§„èŒƒæ•´ç†çš„å¼€å‘æŒ‡å—ã€‚

## 1. é¡¹ç›®ç»“æ„æ¦‚è§ˆ

### æ ¸å¿ƒæ–‡ä»¶ç»“æ„
```
astrbot_plugin_ai_dynamic/
â”œâ”€â”€ main.py           # æ’ä»¶ä¸»æ–‡ä»¶
â”œâ”€â”€ metadata.yaml     # æ’ä»¶å…ƒæ•°æ®
â”œâ”€â”€ requirements.txt  # ä¾èµ–åº“
â”œâ”€â”€ _conf_schema.json # é…ç½®æ¨¡å¼æ–‡ä»¶
â”œâ”€â”€ core/            # æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
â”‚   â”œâ”€â”€ api.py      # APIæ¥å£å°è£…
â”‚   â”œâ”€â”€ post.py     # åŠ¨æ€å‘å¸ƒåŠŸèƒ½
â”‚   â””â”€â”€ utils.py    # å·¥å…·å‡½æ•°
â””â”€â”€ data/           # æ•°æ®å­˜å‚¨ï¼ˆå›¾ç‰‡ã€é…ç½®ç­‰ï¼‰
```

## 2. QQåŠ¨æ€ç›¸å…³APIæ¥å£åˆ†æ

### 2.1 æ ¸å¿ƒAPIæ¨¡å— (core/api.py)
```python
class QZoneAPI:
    """QQç©ºé—´åŠ¨æ€å‘å¸ƒAPIå°è£…ç±»"""
    
    def __init__(self, cookies: str):
        """åˆå§‹åŒ–APIå®¢æˆ·ç«¯
        
        Args:
            cookies: QQç©ºé—´ç™»å½•å‡­æ®
        """
        
    async def publish_dynamic(self, content: str, images: List[str] = None) -> bool:
        """å‘å¸ƒåŠ¨æ€
        
        Args:
            content: åŠ¨æ€æ–‡æœ¬å†…å®¹
            images: å›¾ç‰‡æ–‡ä»¶è·¯å¾„åˆ—è¡¨
            
        Returns:
            å‘å¸ƒæ˜¯å¦æˆåŠŸ
        """
        
    async def upload_image(self, image_path: str) -> str:
        """ä¸Šä¼ å›¾ç‰‡åˆ°QQç©ºé—´
        
        Args:
            image_path: æœ¬åœ°å›¾ç‰‡è·¯å¾„
            
        Returns:
            ä¸Šä¼ åçš„å›¾ç‰‡URL
        """
```

### 2.2 åŠ¨æ€å‘å¸ƒæ¨¡å— (core/post.py)
```python
class DynamicPublisher:
    """åŠ¨æ€å‘å¸ƒå™¨"""
    
    def __init__(self, api: QZoneAPI):
        self.api = api
        
    async def publish_text_dynamic(self, text: str) -> bool:
        """å‘å¸ƒçº¯æ–‡æœ¬åŠ¨æ€"""
        
    async def publish_image_dynamic(self, text: str, images: List[str]) -> bool:
        """å‘å¸ƒå›¾æ–‡åŠ¨æ€"""
        
    async def publish_ai_generated_dynamic(self, prompt: str) -> bool:
        """å‘å¸ƒAIç”Ÿæˆçš„åŠ¨æ€å†…å®¹"""
```

### 2.3 å·¥å…·å‡½æ•°æ¨¡å— (core/utils.py)
```python
def validate_image_format(file_path: str) -> bool:
    """éªŒè¯å›¾ç‰‡æ ¼å¼æ˜¯å¦æ”¯æŒ"""
    
def resize_image_if_needed(image_path: str, max_size: tuple = (1080, 1080)) -> str:
    """è°ƒæ•´å›¾ç‰‡å°ºå¯¸"""
    
def generate_dynamic_content(topic: str, style: str = "casual") -> str:
    """ç”ŸæˆåŠ¨æ€å†…å®¹"""
```

## 3. AstrBotæ’ä»¶å¼€å‘è§„èŒƒ

### 3.1 æ’ä»¶åŸºæœ¬ç»“æ„
```python
from astrbot.api.event import filter, AstrMessageEvent, MessageEventResult
from astrbot.api.star import Context, Star, register
from astrbot.api import logger

@register("ai_dynamic", "ä½œè€…å", "AIåŠ¨æ€å‘å¸ƒæ’ä»¶", "1.0.0", "ä»“åº“åœ°å€")
class AIDynamicPlugin(Star):
    def __init__(self, context: Context, config: dict = None):
        super().__init__(context)
        self.config = config or {}
        # åˆå§‹åŒ–QQç©ºé—´API
        self.qzone_api = None
        if self.config.get('qq_cookies'):
            self.qzone_api = QZoneAPI(self.config['qq_cookies'])
```

### 3.2 æŒ‡ä»¤æ³¨å†Œæ¨¡å¼

#### åŸºç¡€æŒ‡ä»¤
```python
@filter.command("å‘åŠ¨æ€")
async def publish_dynamic(self, event: AstrMessageEvent, content: str):
    """å‘å¸ƒåŠ¨æ€åˆ°QQç©ºé—´
    
    Args:
        content: åŠ¨æ€å†…å®¹
    """
    if not self.qzone_api:
        yield event.plain_result("è¯·å…ˆé…ç½®QQç©ºé—´ç™»å½•ä¿¡æ¯")
        return
        
    try:
        success = await self.qzone_api.publish_dynamic(content)
        if success:
            yield event.plain_result("åŠ¨æ€å‘å¸ƒæˆåŠŸï¼")
        else:
            yield event.plain_result("åŠ¨æ€å‘å¸ƒå¤±è´¥")
    except Exception as e:
        logger.error(f"å‘å¸ƒåŠ¨æ€å‡ºé”™: {e}")
        yield event.plain_result("å‘å¸ƒè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯")
```

#### æŒ‡ä»¤ç»„æ¨¡å¼
```python
@filter.command_group("åŠ¨æ€")
def dynamic_group(self):
    """åŠ¨æ€ç®¡ç†æŒ‡ä»¤ç»„"""
    pass

@dynamic_group.command("å‘å¸ƒ")
async def publish(self, event: AstrMessageEvent, content: str):
    """å‘å¸ƒæ™®é€šåŠ¨æ€"""
    # /åŠ¨æ€ å‘å¸ƒ ä»Šå¤©å¤©æ°”ä¸é”™
    
@dynamic_group.command("aiç”Ÿæˆ")
async def ai_generate(self, event: AstrMessageEvent, topic: str, style: str = "éšæ„"):
    """AIç”ŸæˆåŠ¨æ€å†…å®¹å¹¶å‘å¸ƒ"""
    # /åŠ¨æ€ aiç”Ÿæˆ ä»Šæ—¥å¿ƒæƒ… æ–‡è‰º
    
@dynamic_group.command("å¸¦å›¾å‘å¸ƒ")
async def publish_with_images(self, event: AstrMessageEvent, content: str):
    """å‘å¸ƒå¸¦å›¾ç‰‡çš„åŠ¨æ€ï¼ˆéœ€è¦åœ¨æ¶ˆæ¯ä¸­åŒ…å«å›¾ç‰‡ï¼‰"""
    # å¤„ç†æ¶ˆæ¯ä¸­çš„å›¾ç‰‡
    images = []
    for component in event.message_obj.message:
        if component.type == "image":
            images.append(component.file)
```

### 3.3 äº‹ä»¶ç›‘å¬å™¨
```python
@filter.event_message_type(filter.EventMessageType.ALL)
async def on_message(self, event: AstrMessageEvent):
    """ç›‘å¬æ‰€æœ‰æ¶ˆæ¯ï¼Œå¯ç”¨äºè‡ªåŠ¨åŒ–åŠŸèƒ½"""
    # ä¾‹å¦‚ï¼šæ£€æµ‹åˆ°ç‰¹å®šå…³é”®è¯è‡ªåŠ¨å‘å¸ƒåŠ¨æ€
    message = event.message_str.lower()
    
    if "è‡ªåŠ¨å‘å¸ƒ" in message and event.get_sender_id() in self.config.get('auto_users', []):
        # è§¦å‘è‡ªåŠ¨å‘å¸ƒé€»è¾‘
        pass
```

### 3.4 LLMé›†æˆ
```python
@filter.command("aiåŠ¨æ€")
async def ai_dynamic(self, event: AstrMessageEvent, topic: str):
    """ä½¿ç”¨AIç”Ÿæˆå¹¶å‘å¸ƒåŠ¨æ€"""
    if not self.context.get_using_provider():
        yield event.plain_result("è¯·å…ˆé…ç½®å¤§è¯­è¨€æ¨¡å‹")
        return
        
    # æ„é€ AIæç¤º
    system_prompt = "ä½ æ˜¯ä¸€ä¸ªç¤¾äº¤åª’ä½“å†…å®¹åˆ›ä½œè€…ï¼Œæ“…é•¿åˆ›ä½œæœ‰è¶£çš„åŠ¨æ€å†…å®¹ã€‚"
    user_prompt = f"è¯·ä¸ºä¸»é¢˜'{topic}'åˆ›ä½œä¸€æ¡é€‚åˆQQç©ºé—´çš„åŠ¨æ€å†…å®¹ï¼Œè¦æ±‚è½»æ¾æœ‰è¶£ï¼Œ100å­—ä»¥å†…ã€‚"
    
    try:
        # è°ƒç”¨LLM
        llm_response = await self.context.get_using_provider().text_chat(
            prompt=user_prompt,
            system_prompt=system_prompt,
            contexts=[],
            session_id=None
        )
        
        if llm_response.role == "assistant":
            generated_content = llm_response.completion_text
            
            # å‘å¸ƒç”Ÿæˆçš„å†…å®¹
            if self.qzone_api:
                success = await self.qzone_api.publish_dynamic(generated_content)
                if success:
                    yield event.plain_result(f"AIç”ŸæˆåŠ¨æ€å‘å¸ƒæˆåŠŸï¼\nå†…å®¹ï¼š{generated_content}")
                else:
                    yield event.plain_result(f"å‘å¸ƒå¤±è´¥ï¼Œä½†å†…å®¹å·²ç”Ÿæˆï¼š\n{generated_content}")
            else:
                yield event.plain_result(f"æœªé…ç½®QQç©ºé—´ï¼Œç”Ÿæˆå†…å®¹ï¼š\n{generated_content}")
                
    except Exception as e:
        logger.error(f"AIç”ŸæˆåŠ¨æ€å¤±è´¥: {e}")
        yield event.plain_result("AIç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")
```

## 4. é…ç½®ç®¡ç†

### 4.1 é…ç½®æ–‡ä»¶æ¨¡å¼ (_conf_schema.json)
```json
{
  "qq_cookies": {
    "description": "QQç©ºé—´ç™»å½•Cookies",
    "type": "text",
    "hint": "ä»æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­è·å–çš„QQç©ºé—´ç™»å½•å‡­æ®",
    "obvious_hint": true
  },
  "auto_publish": {
    "description": "æ˜¯å¦å¯ç”¨è‡ªåŠ¨å‘å¸ƒ",
    "type": "bool",
    "default": false,
    "hint": "å¼€å¯åå¯æ ¹æ®è®¾å®šè§„åˆ™è‡ªåŠ¨å‘å¸ƒåŠ¨æ€"
  },
  "auto_users": {
    "description": "å…è®¸è§¦å‘è‡ªåŠ¨å‘å¸ƒçš„ç”¨æˆ·IDåˆ—è¡¨",
    "type": "list",
    "default": [],
    "hint": "åªæœ‰è¿™äº›ç”¨æˆ·å¯ä»¥è§¦å‘è‡ªåŠ¨å‘å¸ƒåŠŸèƒ½"
  },
  "content_filter": {
    "description": "å†…å®¹è¿‡æ»¤é…ç½®",
    "type": "object",
    "items": {
      "enable_filter": {
        "description": "å¯ç”¨å†…å®¹è¿‡æ»¤",
        "type": "bool",
        "default": true
      },
      "banned_words": {
        "description": "ç¦ç”¨è¯åˆ—è¡¨",
        "type": "list",
        "default": []
      }
    }
  },
  "ai_settings": {
    "description": "AIç”Ÿæˆè®¾ç½®",
    "type": "object",
    "items": {
      "default_style": {
        "description": "é»˜è®¤ç”Ÿæˆé£æ ¼",
        "type": "string",
        "default": "éšæ„",
        "options": ["éšæ„", "æ­£å¼", "å¹½é»˜", "æ–‡è‰º", "ç®€æ´"]
      },
      "max_length": {
        "description": "æœ€å¤§å†…å®¹é•¿åº¦",
        "type": "int",
        "default": 100
      }
    }
  }
}
```

### 4.2 é…ç½®ä½¿ç”¨ç¤ºä¾‹
```python
def __init__(self, context: Context, config: dict = None):
    super().__init__(context)
    self.config = config or {}
    
    # è·å–é…ç½®é¡¹
    self.qq_cookies = self.config.get('qq_cookies', '')
    self.auto_publish = self.config.get('auto_publish', False)
    self.auto_users = self.config.get('auto_users', [])
    
    # è·å–åµŒå¥—é…ç½®
    ai_settings = self.config.get('ai_settings', {})
    self.default_style = ai_settings.get('default_style', 'éšæ„')
    self.max_length = ai_settings.get('max_length', 100)
```

## 5. é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

### 5.1 å¼‚å¸¸å¤„ç†æ¨¡å¼
```python
@filter.command("å‘åŠ¨æ€")
async def publish_dynamic(self, event: AstrMessageEvent, content: str):
    try:
        # å‚æ•°éªŒè¯
        if not content.strip():
            yield event.plain_result("åŠ¨æ€å†…å®¹ä¸èƒ½ä¸ºç©º")
            return
            
        if not self.qzone_api:
            yield event.plain_result("è¯·å…ˆåœ¨æ’ä»¶é…ç½®ä¸­è®¾ç½®QQç©ºé—´ç™»å½•ä¿¡æ¯")
            return
            
        # å†…å®¹è¿‡æ»¤
        if self._is_content_blocked(content):
            yield event.plain_result("å†…å®¹åŒ…å«æ•æ„Ÿè¯æ±‡ï¼Œæ— æ³•å‘å¸ƒ")
            return
            
        # æ‰§è¡Œå‘å¸ƒ
        logger.info(f"ç”¨æˆ· {event.get_sender_name()} è¯·æ±‚å‘å¸ƒåŠ¨æ€: {content[:50]}...")
        success = await self.qzone_api.publish_dynamic(content)
        
        if success:
            logger.info(f"åŠ¨æ€å‘å¸ƒæˆåŠŸ")
            yield event.plain_result("âœ… åŠ¨æ€å‘å¸ƒæˆåŠŸï¼")
        else:
            logger.warning(f"åŠ¨æ€å‘å¸ƒå¤±è´¥")
            yield event.plain_result("âŒ åŠ¨æ€å‘å¸ƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç™»å½•çŠ¶æ€")
            
    except Exception as e:
        logger.error(f"å‘å¸ƒåŠ¨æ€æ—¶å‘ç”Ÿå¼‚å¸¸: {e}", exc_info=True)
        yield event.plain_result("å‘å¸ƒè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•")

def _is_content_blocked(self, content: str) -> bool:
    """æ£€æŸ¥å†…å®¹æ˜¯å¦è¢«å±è”½"""
    filter_config = self.config.get('content_filter', {})
    if not filter_config.get('enable_filter', True):
        return False
        
    banned_words = filter_config.get('banned_words', [])
    return any(word in content for word in banned_words)
```

## 6. æ¶ˆæ¯é“¾å’Œå¯Œåª’ä½“å¤„ç†

### 6.1 å¤„ç†å›¾ç‰‡æ¶ˆæ¯
```python
import astrbot.api.message_components as Comp

@filter.command("å›¾ç‰‡åŠ¨æ€")
async def publish_image_dynamic(self, event: AstrMessageEvent, text: str = ""):
    """å‘å¸ƒåŒ…å«å›¾ç‰‡çš„åŠ¨æ€"""
    
    # æå–æ¶ˆæ¯ä¸­çš„å›¾ç‰‡
    images = []
    for component in event.message_obj.message:
        if isinstance(component, Comp.Image):
            if component.url:  # ç½‘ç»œå›¾ç‰‡
                images.append(component.url)
            elif component.file:  # æœ¬åœ°æ–‡ä»¶
                images.append(component.file)
    
    if not images:
        yield event.plain_result("è¯·åœ¨æ¶ˆæ¯ä¸­åŒ…å«å›¾ç‰‡")
        return
        
    try:
        success = await self.qzone_api.publish_dynamic(text, images)
        if success:
            yield event.plain_result(f"âœ… å›¾ç‰‡åŠ¨æ€å‘å¸ƒæˆåŠŸï¼\nåŒ…å« {len(images)} å¼ å›¾ç‰‡")
        else:
            yield event.plain_result("âŒ å›¾ç‰‡åŠ¨æ€å‘å¸ƒå¤±è´¥")
    except Exception as e:
        logger.error(f"å‘å¸ƒå›¾ç‰‡åŠ¨æ€å¤±è´¥: {e}")
        yield event.plain_result("å‘å¸ƒå›¾ç‰‡åŠ¨æ€æ—¶å‡ºç°é”™è¯¯")
```

### 6.2 æ„å»ºå¯Œåª’ä½“å›å¤
```python
@filter.command("åŠ¨æ€é¢„è§ˆ")
async def preview_dynamic(self, event: AstrMessageEvent, content: str):
    """é¢„è§ˆåŠ¨æ€å†…å®¹"""
    
    # ç”Ÿæˆé¢„è§ˆå›¾ç‰‡ï¼ˆå¯é€‰ï¼‰
    preview_image_path = await self._generate_preview_image(content)
    
    # æ„å»ºæ¶ˆæ¯é“¾
    chain = [
        Comp.Plain("ğŸ“ åŠ¨æ€é¢„è§ˆï¼š\n"),
        Comp.Plain(content),
        Comp.Plain("\n\n"),
    ]
    
    if preview_image_path:
        chain.append(Comp.Image.fromFileSystem(preview_image_path))
        
    chain.extend([
        Comp.Plain("\n"),
        Comp.Plain("å›å¤'ç¡®è®¤å‘å¸ƒ'æ¥å‘å¸ƒæ­¤åŠ¨æ€")
    ])
    
    yield event.chain_result(chain)
```

## 7. å¼‚æ­¥ä»»åŠ¡å’Œå®šæ—¶åŠŸèƒ½

### 7.1 å®šæ—¶å‘å¸ƒåŠŸèƒ½
```python
import asyncio
from datetime import datetime, timedelta

def __init__(self, context: Context, config: dict = None):
    super().__init__(context)
    self.config = config or {}
    
    # å¯åŠ¨å®šæ—¶ä»»åŠ¡
    if self.config.get('enable_scheduled_post', False):
        asyncio.create_task(self._scheduled_post_task())

async def _scheduled_post_task(self):
    """å®šæ—¶å‘å¸ƒä»»åŠ¡"""
    while True:
        try:
            await asyncio.sleep(3600)  # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å¾…å‘å¸ƒçš„å®šæ—¶åŠ¨æ€
            scheduled_posts = await self._get_scheduled_posts()
            
            for post in scheduled_posts:
                if self._should_publish_now(post):
                    await self._publish_scheduled_post(post)
                    
        except Exception as e:
            logger.error(f"å®šæ—¶å‘å¸ƒä»»åŠ¡å¼‚å¸¸: {e}")
```

## 8. æœ€ä½³å®è·µå’Œæ³¨æ„äº‹é¡¹

### 8.1 æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨å¼‚æ­¥IOæ“ä½œé¿å…é˜»å¡
- åˆç†è®¾ç½®APIè°ƒç”¨é¢‘ç‡é™åˆ¶
- å›¾ç‰‡å¤„ç†ä½¿ç”¨é€‚å½“çš„å°ºå¯¸å’Œæ ¼å¼

### 8.2 å®‰å…¨è€ƒè™‘
- æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚cookiesï¼‰åŠ å¯†å­˜å‚¨
- è¾“å…¥å†…å®¹è¿‡æ»¤å’ŒéªŒè¯
- é™åˆ¶ç”¨æˆ·æƒé™å’Œæ“ä½œé¢‘ç‡

### 8.3 ç”¨æˆ·ä½“éªŒ
- æä¾›æ¸…æ™°çš„é”™è¯¯æç¤º
- æ”¯æŒæ“ä½œç¡®è®¤å’Œæ’¤é”€
- å“åº”æ—¶é—´ä¼˜åŒ–

### 8.4 æ‰©å±•æ€§è®¾è®¡
- æ¨¡å—åŒ–çš„APIæ¥å£è®¾è®¡
- æ”¯æŒå¤šå¹³å°åŠ¨æ€å‘å¸ƒçš„æ¶æ„é¢„ç•™
- æ’ä»¶é…ç½®çš„å‘åå…¼å®¹æ€§

## 9. æµ‹è¯•å’Œè°ƒè¯•

### 9.1 è°ƒè¯•æŠ€å·§
```python
# ä½¿ç”¨loggerè¿›è¡Œè°ƒè¯•
logger.debug(f"APIè°ƒç”¨å‚æ•°: {params}")
logger.info(f"ç”¨æˆ·æ“ä½œ: {event.get_sender_name()} - {event.message_str}")

# æ¶ˆæ¯ç»“æ„è°ƒè¯•
print(f"åŸå§‹æ¶ˆæ¯: {event.message_obj.raw_message}")
print(f"æ¶ˆæ¯é“¾: {event.message_obj.message}")
```

### 9.2 æµ‹è¯•ç”¨ä¾‹è®¾è®¡
- æ­£å¸¸å‘å¸ƒæµç¨‹æµ‹è¯•
- å¼‚å¸¸æƒ…å†µå¤„ç†æµ‹è¯•
- é…ç½®å˜æ›´æµ‹è¯•
- å¤šç”¨æˆ·å¹¶å‘æµ‹è¯•

è¿™ä»½æ–‡æ¡£æ¶µç›–äº†åŸºäºç°æœ‰QQåŠ¨æ€æ’ä»¶å’ŒAstrBotå¼€å‘è§„èŒƒçš„æ ¸å¿ƒå¼€å‘è¦ç‚¹ï¼Œå¯ä»¥ä½œä¸ºAIåŠ¨æ€æ’ä»¶å¼€å‘çš„å‚è€ƒæŒ‡å—ã€‚